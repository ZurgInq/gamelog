<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" type="image/x-icon" href="1.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
        integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/main.css">
    <script src="js/main.js"></script>
</head>

<body>
    <div class="container">
        <h2>Список игр</h2>
        <div class="row">
            <div class="col">
                <div class="form-group">
                    <a href="edit-game.html">Добавить игру</a>
                </div>
                <div class="form-group">
                    <input id="game-filter-input" placeholder="Поиск" type="text" class="form-control">
                </div>
            </div>
        </div>

        <div class="row">
            <ul id="game-list" class="no-bullets game-list"></ul>
        </div>

        <br>

        <div class="row">
            <div class="col">
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">
                        Экспорт\Импорт
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" onclick="return downloadAsCsv(event);" href="#">Сохранить как csv</a>
                        <a class="dropdown-item" onclick="return exportDBClick(event);" href="#">Экспорт json</a>
                        <a class="dropdown-item" onclick="return importDBClick(event);" href="#">Импорт json</a>
                    </div>
                </div>
                <input id="importDBInput" type="file" class="invisible" />
            </div>
        </div>

    </div>
    <script>
			const templates = {gameItem(gameTitle, gamesCount, players, addTitleMarker) { return `
<li>
    ${addTitleMarker ? `<strong class="titleMarker">${gameTitle[0]}</strong>` : ''}
    <a href="edit-games.html?editTitle=${gameTitle}"><i class="bi bi-pencil"></i> ${gameTitle}</a>
    <a href="edit-game.html?title=${gameTitle}"><i class="bi bi-file-plus"></i> Добавить</a> <br>
    Количество игр: ${gamesCount}<br>
    ${players.map((player) => {
        return `${player.name}: <span style="color:green">${player.winCount}</span> / <span style="color:red">${player.loseCount}</span>${!player.drawCount ? '' : player.drawCount}<br>`;
    })}
    <small><span style="color:green">Побед</span> / <span style="color:red">Поражений</span> / Ничьи</small>
    <hr>
</li>
`; },}
	</script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const gameListContainer = document.getElementById('game-list');

        const filterChangeEvent = debounceFn(function (event) {
            renderGameList(event.target.value.toLowerCase());
        }, 200);

        document.getElementById('game-filter-input').addEventListener("keyup", filterChangeEvent);

        function renderGameList(gameFilterValue = '') {
            openDB().then(async (db) => {
                const games = await db.getAll('games');
                const gamesByTitle = [];
                for (const game of games) {
                    if (!gamesByTitle[game.gameTitle]) {
                        gamesByTitle[game.gameTitle] = [];
                    }
                    gamesByTitle[game.gameTitle].push(game);
                }

                const titles = Object.keys(gamesByTitle);
                titles.sort();

                let lastTitle = '';
                gameListContainer.innerHTML = '';
                for (const gameTitle of titles) {
                    if (gameFilterValue !== '' && !gameTitle.toLowerCase().includes(gameFilterValue)) {
                        continue;
                    }
                    const playersByName = [];
                    const games = gamesByTitle[gameTitle];
                    for (const game of games) {
                        for (const player of (game.players ?? [])) {
                            playersByName[player.name] ??= [];
                            playersByName[player.name].push(player);
                        }
                    }
                    gameListContainer.insertAdjacentHTML('beforeend', templates.gameItem(
                        gameTitle,
                        games.length,
                        playersByName.map((player) => {
                            return {
                                name: player.name,
                                winCount: getWinners({ players: playersByName[playerName] }).length,
                                loseCount: getLosers({ players: playersByName[playerName] }).length,
                                drawCount: getDraws({ players: playersByName[playerName] }).length,
                            }
                        }),
                        gameTitle[0] !== lastTitle[0],
                    ));
                    lastTitle = gameTitle;
                }
            });
        }

        function downloadAsCsv(event) {
            event.preventDefault();
            openDB().then(db => {
                db.getAll('games').then(games => {
                    const rows = [
                        ["id", "Название игры", "Дата игры", "Длительность", "Теги", "Имя игрока", "Результат", "Очки", "Игрок - теги"],
                    ];
                    games.forEach(game => {
                        let winners = '';
                        if (game.players && game.players.length > 0) {
                            winners = getWinnersNames(game);
                        } else {
                            game.players = [{}];
                        }
                        game.players.forEach((player, idx) => {
                            rows.push([
                                game.id,
                                escapeCSVString(game.gameTitle),
                                game.gameDate,
                                game.gameDuration,
                                escapeCSVString(game.tags ?? ''),
                                player.name ?? '',
                                player.result ?? '',
                                player.score ?? '',
                                player.tags ?? '',
                            ]);
                        });
                    });
                    let csvContent = rows.map(e => e.join(',')).join("\n");

                    const file = new File([csvContent], 'my-games.csv', {
                        type: 'text/csv',
                    });
                    downloadFile(file);
                });
                return false;
            });
            return false;
        }

        function exportDBClick(event) {
            event.preventDefault();
            (async () => {
                const data = await exportDb();
                const file = new File([JSON.stringify(data)], 'db1.json', {
                    type: 'application/json',
                });
                downloadFile(file);
            })();
            return false;
        }

        function importDBClick(event) {
            event.preventDefault();
            document.getElementById('importDBInput').click();
            return false;
        }

        renderGameList(document.getElementById('game-filter-input').value);

        document.getElementById('importDBInput').addEventListener('change', (event) => {
            var reader = new FileReader();
            reader.onload = (event) => {
                const dbData = JSON.parse(event.target.result);
                importDb(dbData).then(() => window.location.reload());
            };
            reader.readAsText(event.target.files[0]);
        });
    </script>
</body>

</html>